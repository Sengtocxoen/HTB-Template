#!/usr/bin/env python3
import subprocess
import logging
from typing import Dict, List, Optional

class ToolManager:
    def __init__(self, logger: Optional[logging.Logger] = None):
        self.tools: Dict[str, bool] = {}
        self.logger = logger or logging.getLogger(__name__)
        self.required_tools = {
            "nmap": "nmap --version",
            "masscan": "masscan --version",
            "whatweb": "whatweb --version",
            "subfinder": "subfinder -version",
            "amass": "amass -version",
            "theharvester": "theHarvester -h",
            "wappalyzer": "wappalyzer --version"
        }
        self.verify_installations()
    
    def verify_installations(self) -> None:
        """Verify that required tools are installed before testing begins"""
        self.logger.info("Verifying required tool installations...")
        
        for tool, check_cmd in self.required_tools.items():
            try:
                result = subprocess.run(check_cmd.split(), capture_output=True, text=True)
                self.tools[tool] = result.returncode == 0
                if self.tools[tool]:
                    self.logger.info(f"✓ {tool} is installed")
                else:
                    self.logger.warning(f"✗ {tool} is not installed or not working properly")
            except Exception as e:
                self.tools[tool] = False
                self.logger.error(f"Error checking {tool}: {str(e)}")
    
    def get_installed_tools(self) -> List[str]:
        """Get list of installed tools"""
        return [tool for tool, installed in self.tools.items() if installed]
    
    def get_missing_tools(self) -> List[str]:
        """Get list of missing tools"""
        return [tool for tool, installed in self.tools.items() if not installed]
    
    def is_tool_installed(self, tool_name: str) -> bool:
        """Check if a specific tool is installed"""
        return self.tools.get(tool_name, False)
    
    def run_tool(self, tool_name: str, command: str, capture_output: bool = True) -> Optional[str]:
        """Run a tool command with proper error handling"""
        if not self.is_tool_installed(tool_name):
            self.logger.error(f"Cannot run {tool_name}: Tool not installed")
            return None
            
        try:
            result = subprocess.run(command.split(), capture_output=capture_output, text=True)
            if result.returncode != 0:
                self.logger.error(f"Error running {tool_name}: {result.stderr}")
                return None
            return result.stdout if capture_output else "Command executed successfully"
        except Exception as e:
            self.logger.error(f"Error executing {tool_name}: {str(e)}")
            return None 